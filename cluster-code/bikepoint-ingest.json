{"paragraphs":[{"text":"%sh\nwget \"https://api.tfl.gov.uk/bikepoint\" -O /home/slbm/bikepoint-latest/latest.json\necho \"download complete\"","dateUpdated":"2017-08-08T09:07:58+0000","config":{"colWidth":12,"editorMode":"ace/mode/sh","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1502147210903_-1682287371","id":"20170614-113937_494163114","result":{"code":"SUCCESS","type":"TEXT","msg":"download complete\n"},"dateCreated":"2017-08-07T23:06:50+0000","dateStarted":"2017-08-08T09:15:00+0000","dateFinished":"2017-08-08T09:15:00+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:767"},{"text":"%pyspark\nimport json\nimport pandas as pd\nimport datetime\nimport time\n\ni = datetime.datetime.now()\nts = i.isoformat()\n\n\n# wait for file to be downloaded\ntime.sleep(10)\nf = open(\"/home/slbm/bikepoint-latest/latest.json\", \"r\")\njf = json.load(f)\n\ncolumns = [\"polled_time\", \"update_time\", \"lat\", \"lon\", \"bikes\", \"spaces\", \"docks\"]\ndf = pd.DataFrame(columns = columns)\n\nfor bikepoint in jf:\n\n    bikes = 0\n    spaces = 0\n    docks = 0\n\n    for props in bikepoint[\"additionalProperties\"]:\n        if props[\"key\"] == \"NbBikes\":\n            bikes = props[\"value\"]\n            update_time = props[\"modified\"]\n        if props[\"key\"] == \"NbEmptyDocks\":\n            spaces = props[\"value\"]\n        if props[\"key\"] == \"NbDocks\":\n            docks = props[\"value\"]\n            \n    newRec = {\"polled_time\": ts,\n        \"update_time\": update_time,\n        \"lat\": bikepoint[\"lat\"],\n        \"lon\": bikepoint[\"lon\"],\n        \"bikes\": bikes,\n        \"spaces\": spaces,\n        \"docks\": docks\n    }\n    newDf = pd.DataFrame(newRec, index=[bikepoint[\"id\"]])\n    df = df.append(newDf)\n\ndf.to_csv(\"/home/slbm/bikepoint-latest/\" + i.strftime(\"%Y%m%d-%H%M\") + \".csv\", index=True, header=False)\n","dateUpdated":"2017-08-08T09:07:58+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1502147210903_-1682287371","id":"20170614-115115_1111602476","result":{"code":"SUCCESS","type":"TEXT","msg":""},"dateCreated":"2017-08-07T23:06:50+0000","dateStarted":"2017-08-08T09:15:00+0000","dateFinished":"2017-08-08T09:15:11+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:769","focus":true},{"text":"%sh\nsleep 30\nhadoop fs -copyFromLocal ~/bikepoint-latest/*.csv /user/slbm/bikepoint-history\nrm ~/bikepoint-latest/latest.json\nrm ~/bikepoint-latest/*.csv","dateUpdated":"2017-08-08T09:16:34+0000","config":{"colWidth":12,"editorMode":"ace/mode/sh","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1502147210903_-1682287371","id":"20170614-123141_577364902","result":{"code":"SUCCESS","type":"TEXT","msg":""},"dateCreated":"2017-08-07T23:06:50+0000","dateStarted":"2017-08-08T09:16:34+0000","dateFinished":"2017-08-08T09:17:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:770","user":"slbm","focus":true},{"dateUpdated":"2017-08-08T09:13:07+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1502147210903_-1682287371","id":"20170614-132251_1320283221","result":{"code":"SUCCESS","type":"TEXT","msg":""},"dateCreated":"2017-08-07T23:06:50+0000","dateStarted":"2017-08-08T09:15:00+0000","dateFinished":"2017-08-08T09:17:46+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:771","text":"%pyspark\r\n\r\ntime.sleep(120)\r\nfrom pyspark.sql import functions as F\r\n\r\nhistory = sqlContext.sql(\"\"\"\r\nSELECT *,\r\nmax(spaces) over(partition by id order by polled_time rows between 2 preceding and 1 preceding) as spaces_lag1,\r\nmax(spaces) over(partition by id order by polled_time rows between 3 preceding and 2 preceding) as spaces_lag2,\r\nmax(spaces) over(partition by id order by polled_time rows between 4 preceding and 3 preceding) as spaces_lag3,\r\nROW_NUMBER() OVER (PARTITION BY id ORDER BY polled_time DESC) as rn\r\nFROM bikepoint.history_ext\r\nORDER BY id, polled_time\"\"\")\r\n\r\nhistory.cache()\r\n\r\nhistory = (history.withColumn(\"polled_time\", F.col(\"polled_time\").cast(\"timestamp\"))\r\n    .withColumn(\"update_time\", F.col(\"update_time\").cast(\"timestamp\"))\r\n    .withColumn(\"polled_time_hr\", F.hour(\"polled_time\"))\r\n    .withColumn(\"polled_time_mn\", F.minute(\"polled_time\"))\r\n    .withColumn(\"polled_time_seg\", F.col(\"polled_time_hr\") + F.col(\"polled_time_mn\") / 60)\r\n    .withColumn(\"polled_time_ampk\", F.col(\"polled_time_seg\").between(7.5, 10).cast(\"integer\"))\r\n    .withColumn(\"polled_time_pmpk\", F.col(\"polled_time_seg\").between(16, 19).cast(\"integer\"))\r\n    .withColumn(\"polled_time_dayofweek\", F.date_format(\"polled_time\", \"u\"))\r\n    .withColumn(\"polled_time_weekday\", (F.col(\"polled_time_dayofweek\") < 6).cast(\"integer\")))\r\n\r\nhistory = history.dropna()\r\nhistory.write.saveAsTable(\"bikepoint.history\", mode=\"overwrite\")","focus":true},{"config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1502183279016_-1014381588","id":"20170808-090759_1349827449","dateCreated":"2017-08-08T09:07:59+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1135","dateFinished":"2017-08-08T09:15:12+0000","dateStarted":"2017-08-08T09:15:12+0000","result":{"code":"SUCCESS","type":"TEXT","msg":""}}],"name":"bikepoint-ingest","id":"2CRR79JVJ","angularObjects":{"2CQ6SDH2W:shared_process":[],"2CS2E3Q91:shared_process":[],"2CRBJ7488:shared_process":[],"2CS91QREC:shared_process":[],"2CPYHC9NX:shared_process":[],"2CPZYXM8Q:shared_process":[],"2CQJTNN1R:shared_process":[],"2CP3MEWRV:shared_process":[],"2CP5UZT9P:shared_process":[],"2CQTAAPS8:shared_process":[],"2CRXYGT75:shared_process":[],"2CR5ZSWEU:shared_process":[],"2CRCY2WCF:shared_process":[],"2CQUS5RVB:shared_process":[],"2CSFBYJ7T:shared_process":[],"2CPHRDPAZ:shared_process":[],"2CSB93HGB:shared_process":[]},"config":{"looknfeel":"default","cron":"0 0/10 * * * ?"},"info":{}}